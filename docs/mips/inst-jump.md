# 分支/跳转类指令

## 跳转类型

#### 近跳转

分支指令使用**近跳转**，跳转偏移为 16 位（`[15:0]`）的 `addr` 字段。

计算方式为，将偏移量左移两位，然后带符号扩展到 32 位，与发生跳转时的 PC 值（即，当具有延迟分支时为跳转指令的地址 +4，否则为跳转指令的地址）相加，作为新的 PC 值。

#### 远跳转

基于标签（或字面量偏移）的跳转指令使用**远跳转**，跳转偏移为 26 位（`[25:0]`）的 `jmpaddr` 字段。

计算方式为，取发生跳转时的 PC 值（即，当具有延迟分支时为跳转指令的地址 +4，否则为跳转指令的地址）的高 4 位作为高 4 位，取偏移量作为中间 26 位，取 0 作为低 2 位，组合起来作为新的 PC 值。

#### 绝对跳转

将读到的寄存器中的 32 位整数值直接作为新的 PC 值，通常用于在跳转并连接类型的指令（`JR` / `JALR`）之后返回。

## 分支指令

以下分支指令均为相等/不相等的比较，或是与 0 的大小比较，所以不需要 ALU 即可简单地完成。在流水线寄存器中，它们的条件判断被提前到 ID 级，在有分支延迟槽的情况下无需阻塞流水线。

所有分支指令的跳转类型均为[相对跳转]()。

### `BEQ` 相等时跳转

* **类型** I 型
* **Verilog 表达式** `32'b000100_????????????????????_??????`
* **编码**
    * `op = 000100`
    * `rs` 源寄存器：操作数 1
    * `rt` 源寄存器：操作数 2
    * `addr` 跳转偏移

将两个寄存器的值相比较，如果相等，则以给定的常数偏移进行一次近跳转。

### `BNE` 不等时跳转

* **类型** I 型
* **Verilog 表达式** `32'b000101_????????????????????_??????`
* **编码**
    * `op = 000101`
    * `rs` 源寄存器：操作数 1
    * `rt` 源寄存器：操作数 2
    * `addr` 跳转偏移

将两个寄存器的值相比较，如果不等，则以给定的常数偏移进行一次近跳转。

### `BLTZ` 小于零时跳转

* **类型** I 型
* **Verilog 表达式** `32'b000001_?????00000??????????_??????`
* **编码**
    * `op = 000001`
    * `rs` 源寄存器：操作数
    * `rt = 00000`
    * `addr` 跳转偏移

将一个寄存器的值与 0 比较，如果小于 0，则以给定的常数偏移进行一次近跳转。

### `BLEZ` 小于或等于零时跳转

* **类型** I 型
* **Verilog 表达式** `32'b000110_?????00000??????????_??????`
* **编码**
    * `op = 000110`
    * `rs` 源寄存器：操作数
    * `rt = 00000`
    * `addr` 跳转偏移

将一个寄存器的值与 0 比较，如果小于或等于 0，则以给定的常数偏移进行一次近跳转。

### `BGTZ` 大于零时跳转

* **类型** I 型
* **Verilog 表达式** `32'b000111_?????00000??????????_??????`
* **编码**
    * `op = 000111`
    * `rs` 源寄存器：操作数
    * `rt = 00000`
    * `addr` 跳转偏移

将一个寄存器的值与 0 比较，如果大于 0，则以给定的常数偏移进行一次近跳转。

### `BGEZ` 大于或等于零时跳转

* **类型** I 型
* **Verilog 表达式** `32'b000001_?????00001??????????_??????`
* **编码**
    * `op = 000001`
    * `rs` 源寄存器：操作数
    * `rt = 00001`
    * `addr` 跳转偏移

将一个寄存器的值与 0 比较，如果大于或等于 0，则以给定的常数偏移进行一次近跳转。

## 跳转指令

### `J` 跳转

* **类型** J 型
* **Verilog 表达式** `32'b000010_????????????????????_??????`
* **编码**
    * `op = 000010`
    * `jmpaddr` 跳转偏移

以给定的常数偏移进行一次远跳转。

### `JAL` 跳转并连接

* **类型** J 型
* **Verilog 表达式** `32'b000011_????????????????????_??????`
* **编码**
    * `op = 000011`
    * `jmpaddr` 跳转偏移

以给定的常数偏移进行一次远跳转，并将返回地址（回到跳转发生位置后要执行的第一条指令的地址，即，当具有延迟分支时为该指令地址 +8，否则为 +4）写入到 `$ra` 寄存器（`$31`）中。

### `JR` 跳转到寄存器地址

* **类型** R 型
* **Verilog 表达式** `32'b000000_????????????????????_001000`
* **编码**
    * `op = 000000`
    * `func = 001000`
    * `rs` 存有跳转偏移的寄存器

以寄存器中的地址进行一次绝对跳转。

### `JALR` 跳转到寄存器地址并连接

* **类型** R 型
* **Verilog 表达式** `32'b000000_????????????????????_001001`
* **编码**
    * `op = 000000`
    * `func = 001001`
    * `rs` 存有跳转偏移的寄存器
    * `rd` 用于写入返回地址的寄存器

以寄存器中的地址进行一次绝对跳转，并将返回地址（回到跳转发生位置后要执行的第一条指令的地址，即，当具有延迟分支时为该指令地址 +8，否则为 +4）写入到指定的寄存器中。

## 系统调用

系统调用的指令比较特殊，它不属于分支/跳转，但处于方便分类的目的将它归到这里来。

### `SYSCALL` 系统调用

* **类型** R 型
* **Verilog 表达式** `32'b000000_????????????????????_001100`
* **编码**
    * `op = 000000`
    * `func = 001100`

在本课程中，该指令仅用于暂停或结束 Verilog 代码的执行。
